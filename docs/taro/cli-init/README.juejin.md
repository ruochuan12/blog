---
highlight: darcula
theme: smartblue
---

## 1. å‰è¨€

å¤§å®¶å¥½ï¼Œæˆ‘æ˜¯[è‹¥å·](https://juejin.cn/user/1415826704971918)ï¼Œæ¬¢è¿å…³æ³¨æˆ‘çš„[å…¬ä¼—å·ï¼šè‹¥å·è§†é‡](https://mp.weixin.qq.com/s/MacNfeTPODNMLLFdzrULow)ã€‚æˆ‘å€¾åŠ›æŒç»­ç»„ç»‡äº† 3 å¹´å¤š[æ¯å‘¨å¤§å®¶ä¸€èµ·å­¦ä¹  200 è¡Œå·¦å³çš„æºç å…±è¯»æ´»åŠ¨](https://juejin.cn/post/7079706017579139102)ï¼Œæ„Ÿå…´è¶£çš„å¯ä»¥[ç‚¹æ­¤æ‰«ç åŠ æˆ‘å¾®ä¿¡ `ruochuan02` å‚ä¸](https://juejin.cn/pin/7217386885793595453)ã€‚å¦å¤–ï¼Œæƒ³å­¦æºç ï¼ŒæåŠ›æ¨èå…³æ³¨æˆ‘å†™çš„ä¸“æ [ã€Šå­¦ä¹ æºç æ•´ä½“æ¶æ„ç³»åˆ—ã€‹](https://juejin.cn/column/6960551178908205093)ï¼Œç›®å‰æ˜¯æ˜é‡‘å…³æ³¨äººæ•°ï¼ˆ6k+äººï¼‰ç¬¬ä¸€çš„ä¸“æ ï¼Œå†™æœ‰å‡ åç¯‡æºç æ–‡ç« ã€‚

æˆªè‡³ç›®å‰ï¼ˆ`2024-07-12`ï¼‰ï¼Œ`taro` æ­£å¼ç‰ˆæ˜¯ `3.6.34`ï¼Œ[Taro 4.0 Beta å‘å¸ƒï¼šæ”¯æŒå¼€å‘é¸¿è’™åº”ç”¨ã€å°ç¨‹åºç¼–è¯‘æ¨¡å¼ã€Vite ç¼–è¯‘ç­‰](https://juejin.cn/post/7330792655125463067)ã€‚æ–‡ç« æåˆ°å°†äº 2024 å¹´ç¬¬äºŒå­£åº¦ï¼Œå‘å¸ƒ `4.x`ã€‚æ‰€ä»¥æˆ‘ä»¬ç›´æ¥å­¦ä¹  `4.x`ï¼Œ`4.x` æœ€æ–°ç‰ˆæœ¬æ˜¯ `4.0.0`ã€‚

[å¤šç¼–è¯‘å†…æ ¸ç”Ÿæ€ä¸‹çš„æé€Ÿç ”å‘ä½“éªŒ](https://taro-docs.jd.com/blog/2023/03/29/D2_17) å®˜æ–¹åšå®¢æœ‰å¦‚ä¸‹å›¾ã€‚

![å¤šç¼–è¯‘å†…æ ¸æ¶æ„](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/85718d9f74004f45910a2c7459f999ab~tplv-k3u1fbpfcp-jj-mark:0:0:0:0:q75.image#?w=960&h=540&s=363552&e=png&b=030617)

è®¡åˆ’å†™ä¸€ä¸ª `taro` æºç æ­ç§˜ç³»åˆ—ï¼Œæ¬¢è¿æŒç»­å…³æ³¨ã€‚åˆæ­¥è®¡åˆ’æœ‰å¦‚ä¸‹æ–‡ç« ï¼š

*   [x] [Taro æºç æ­ç§˜ - 1. æ­å¼€æ•´ä¸ªæ¶æ„çš„å…¥å£ CLI => taro init åˆå§‹åŒ–é¡¹ç›®çš„ç§˜å¯†](https://juejin.cn/post/7378363694939783178)
*   [x] [Taro æºç æ­ç§˜ - 2. æ­å¼€æ•´ä¸ªæ¶æ„çš„æ’ä»¶ç³»ç»Ÿçš„ç§˜å¯†](https://juejin.cn/post/7380195796208205824)
*   [x] [Taro æºç æ­ç§˜ - 3. æ¯æ¬¡åˆ›å»ºæ–°çš„ taro é¡¹ç›®ï¼ˆtaro initï¼‰çš„èƒŒååŸç†æ˜¯ä»€ä¹ˆ](https://juejin.cn/post/7390335741586931738)
*   [ ] cli build
*   [ ] ç­‰ç­‰

å­¦å®Œæœ¬æ–‡ï¼Œä½ å°†å­¦åˆ°ï¼š

```bash
1. å­¦ä¼šé€šè¿‡ä¸¤ç§æ–¹å¼è°ƒè¯• taro æºç 
2. å­¦ä¼šå…¥å£ taro-cli å…·ä½“å®ç°æ–¹å¼
3. å­¦ä¼š cli init å‘½ä»¤å®ç°åŸç†ï¼Œè¯»å–ç”¨æˆ·é¡¹ç›®é…ç½®æ–‡ä»¶å’Œç”¨æˆ·å…¨å±€é…ç½®æ–‡ä»¶
4. å­¦ä¼š taro-service kernal ï¼ˆå†…æ ¸ï¼‰è§£è€¦å®ç°
5. åˆæ­¥å­¦ä¼š taro æ’ä»¶æ¶æ„ï¼Œå­¦ä¼šå¦‚ä½•ç¼–å†™ä¸€ä¸ª taro æ’ä»¶
```

## 2. å‡†å¤‡å·¥ä½œ

```bash
# å…‹éš†é¡¹ç›®
git clone https://github.com/NervJS/taro.git
# åˆ‡æ¢åˆ°åˆ†æ”¯ 4.x
git checkout 4.x
# å†™æ–‡ç« æ—¶ï¼Œé¡¹ç›®å½“å‰ hash
git checkout a7fcf67b3acd065b85f2fdc8d999b9d2cb2f3058
# chore(release): publish 4.0.0 --tag=next
# å†™æ–‡ç« æ—¶ï¼Œå½“å‰ç‰ˆæœ¬
# 4.0.0
```

åç»­æ–‡ç« å°½é‡ä¼šä¸ `taro` `4.x` ç‰ˆæœ¬ä¿æŒæ›´æ–°ã€‚

çœ‹ä¸€ä¸ªå¼€æºé¡¹ç›®ï¼Œç¬¬ä¸€æ­¥åº”è¯¥æ˜¯å…ˆçœ‹ [README.md](https://github.com/NervJS/taro.git) å†çœ‹ [è´¡çŒ®æ–‡æ¡£](https://github.com/NervJS/taro/blob/4.x/CONTRIBUTING.md) å’Œ `package.json`ã€‚

ç¯å¢ƒå‡†å¤‡

> éœ€è¦å®‰è£… [Node.js 16](https://nodejs.org/en/)ï¼ˆå»ºè®®å®‰è£… `16.20.0` åŠä»¥ä¸Šç‰ˆæœ¬ï¼‰åŠ [pnpm 7](https://pnpm.io/zh/installation)

æˆ‘ä½¿ç”¨çš„ç¯å¢ƒï¼š`mac`ï¼Œå½“ç„¶ `Windows` ä¸€æ ·å¯ä»¥ã€‚

ä¸€èˆ¬ç”¨ [nvm](https://github.com/nvm-sh/nvm) ç®¡ç† `node` ç‰ˆæœ¬ã€‚

```zsh
nvm install 18
nvm use 18
# å¯ä»¥æŠŠ node é»˜è®¤ç‰ˆæœ¬è®¾ç½®ä¸º 18ï¼Œè°ƒè¯•æ—¶ä¼šä½¿ç”¨é»˜è®¤ç‰ˆæœ¬
nvm alias default 18

pnpm -v
# 9.1.1
node -v
# v18.20.2

cd taro
# å®‰è£…ä¾èµ–
pnpm i
# ç¼–è¯‘æ„å»º
pnpm build
```

```bash
# åˆ é™¤æ ¹ç›®å½•çš„ node_modules å’Œæ‰€æœ‰ workspace é‡Œçš„ node_modules
$ pnpm run clear-all
# å¯¹åº”çš„æ˜¯ï¼šrimraf **/node_modules
# mac ä¸‹å¯ä»¥ç”¨ rm -rf **/node_modules
```

å®‰è£…ä¾èµ–å¯èƒ½ä¼šæŠ¥é”™ã€‚

![pnpm-i-error.png](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/edef5301eec7477f9094f4e0cf035d24~tplv-k3u1fbpfcp-jj-mark:0:0:0:0:q75.image#?w=2906&h=474&s=170652&e=png&b=020202)

```bash
Failed to set up Chromium r1108766! Set "PUPPETEER_SKIP_DOWNLOAD" env variable to skip download.
```

é€šè¿‡è°·æ­Œç­‰æœç´¢å¼•æ“å¯ä»¥æ‰¾åˆ°è§£å†³æ–¹æ³•ã€‚

[stackoverflow](https://stackoverflow.com/questions/63187371/puppeteer-is-not-able-to-install-error-failed-to-set-up-chromium-r782078-set)

Mac : `export PUPPETEER_SKIP_DOWNLOAD='true'`
Windows: `SET PUPPETEER_SKIP_DOWNLOAD='true'`

pnpm build å®Œæˆï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![pnpm-build.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/3b54216574f44c5088b50b48ccafa5a9~tplv-k3u1fbpfcp-jj-mark:0:0:0:0:q75.image#?w=3314&h=968&s=296242&e=png&b=010101)

## 3. è°ƒè¯•

package.json

```json
// packages/taro-cli/package.json
{
	"name": "@tarojs/cli",
	"version": "4.0.0",
	"description": "cli tool for taro",
	"main": "index.js",
	"types": "dist/index.d.ts",
	"bin": {
		"taro": "bin/taro"
	}
}
```

### 3.1 å…¥å£æ–‡ä»¶ packages/taro-cli/bin/taro

```js
// packages/taro-cli/bin/taro

#! /usr/bin/env node

require("../dist/util").printPkgVersion();

const CLI = require("../dist/cli").default;

new CLI().run();
```

### 3.2 è°ƒè¯•æ–¹æ³• 1 JavaScript Debug Terminal

å¯å‚è€ƒæˆ‘çš„æ–‡ç« [æ–°æ‰‹å‘ï¼šå‰ç«¯ç¨‹åºå‘˜å¿…å­¦åŸºæœ¬æŠ€èƒ½â€”â€”è°ƒè¯• JS ä»£ç ](https://juejin.cn/post/7030584939020042254)ï¼Œæˆ–è€…[æ®è¯´ 90%çš„äººä¸çŸ¥é“å¯ä»¥ç”¨æµ‹è¯•ç”¨ä¾‹(Vitest)è°ƒè¯•å¼€æºé¡¹ç›®(Vue3) æºç ](https://juejin.cn/post/7212263304394981432)

ç®€è€Œè¨€ä¹‹å°±æ˜¯ä»¥ä¸‹æ­¥éª¤ï¼š

```bash
1. æ‰¾åˆ°å…¥å£æ–‡ä»¶è®¾ç½®æ–­ç‚¹
2. ctrl + `\`` (åå¼•å·) æ‰“å¼€ç»ˆç«¯ï¼Œé…ç½®`JavaScriptè°ƒè¯•ç»ˆç«¯`
3. åœ¨ç»ˆç«¯è¾“å…¥ `node` ç›¸å…³å‘½ä»¤ï¼Œè¿™é‡Œç”¨ `init` ä¸¾ä¾‹
4. å°½æƒ…è°ƒè¯•æºç 
```

```bash
node ./packages/taro-cli/bin/taro init taro-init-debug
```

æœ¬æ–‡å°†éƒ½æ˜¯ä½¿ç”¨ `init` å‘½ä»¤ä½œä¸ºç¤ºä¾‹ã€‚

å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![vscode è°ƒè¯•æºç ](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/9a0d04d62ce64702b5a558c6c3f1fa5d~tplv-k3u1fbpfcp-jj-mark:0:0:0:0:q75.image#?w=3840&h=1982&s=636817&e=png&b=272727)

è°ƒè¯•æ—¶åº”è¯¥ä¼šæŠ¥é”™ `binding` `taro.[os-platform].node`ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![binding-error.png](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/7f1d20328bf24cc0993589f5da4adc95~tplv-k3u1fbpfcp-jj-mark:0:0:0:0:q75.image#?w=3666&h=1164&s=355043&e=png&b=262626)

è¿è¡Œç­‰è¿‡ç¨‹æŠ¥é”™ï¼Œä¸è¦æ…Œã€‚å¯èƒ½æ˜¯æˆ‘ä»¬é—æ¼äº†ä¸€äº›ç»†èŠ‚ï¼Œè´¡çŒ®æ–‡æ¡£ç­‰åº”è¯¥ä¼šç»™å‡ºç­”æ¡ˆã€‚æ‰€ä»¥å†æ¥çœ‹ä¸‹ [è´¡çŒ®æ–‡æ¡£-10-rust-éƒ¨åˆ†](https://github.com/NervJS/taro/blob/4.x/CONTRIBUTING.md#10-rust-%E9%83%A8%E5%88%86)

![binding-rust.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/5761d804a3c943d587fa8f6ceb5b3a74~tplv-k3u1fbpfcp-jj-mark:0:0:0:0:q75.image#?w=2014&h=1084&s=244735&e=png&b=0e1218)

é€šè¿‡ [rustup](https://rustup.rs) æ‰¾åˆ°å®‰è£…å‘½ä»¤ï¼š

```bash
curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh
```

å®‰è£…å®Œæˆåï¼Œæ‰§è¡Œ `pnpm run build:binding:debug` æˆ– `pnpm run binding:release` ç¼–è¯‘å‡ºæ–‡ä»¶ï¼š`crates/native_binding/taro.darwin-arm64.node`ã€‚

å°±å®Œç¾è§£å†³äº†ï¼Œè°ƒè¯•æ—¶ä¸ä¼šæŠ¥é”™äº†ã€‚

### 3.3 è°ƒè¯•æ–¹å¼ 2 é…ç½® .vscode/launch.json

[taro æ–‡æ¡£ - å•æ­¥è°ƒæµ‹é…ç½®](https://docs.taro.zone/docs/debug-config/)
å†™çš„æŒºå¥½çš„ï¼Œé€šè¿‡é…ç½® `launch.json` æ¥è°ƒè¯•ï¼Œåœ¨æ­¤å°±ä¸å†èµ˜è¿°äº†ã€‚

ä¸è¿‡è¡¥å……ä¸€æ¡ï¼š`launch.json` æ–‡ä»¶å¯ä»¥æ·»åŠ ä¸€æ¡ `"console": "integratedTerminal"`ï¼ˆé›†æˆç»ˆç«¯ï¼‰é…ç½®ï¼Œå°±å¯ä»¥åœ¨è°ƒè¯•ç»ˆç«¯è¾“å…¥å†…å®¹ã€‚`args` å‚æ•°æ·»åŠ  `init` å’ŒæŒ‡å®šè¦åˆå§‹åŒ–é¡¹ç›®çš„æ–‡ä»¶å¤¹ã€‚å½“ç„¶è°ƒè¯•å…¶ä»–çš„æ—¶å€™ä¹Ÿå¯ä»¥ä¿®æ”¹ä¸ºå…¶ä»–å‚æ•°ã€‚æ¯”å¦‚`args: ["build", "--type", "weapp", "--watch"]`ã€‚

```json
{
	"version": "0.2.0",
	"configurations": [
		{
			"type": "node",
			"request": "launch",
			"name": "CLI debug",
			"program": "${workspaceFolder}/packages/taro-cli/bin/taro",
			// "cwd": "${project absolute path}",
			"args": [
				"init",
				"taro-init-debug",
			],
			"skipFiles": ["<node_internals>/**"],
			"console": "integratedTerminal"
		}
	]
}
```

[vscode nodejs è°ƒè¯•](https://code.visualstudio.com/docs/nodejs/nodejs-debugging#_node-console)

`console- å¯åŠ¨ç¨‹åºçš„æ§åˆ¶å°ï¼ˆinternalConsoleï¼ŒintegratedTerminalï¼ŒexternalTerminalï¼‰ã€‚`

![vscode-console.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/e00d93ab56114dd388b480854b023481~tplv-k3u1fbpfcp-jj-mark:0:0:0:0:q75.image#?w=1558&h=468&s=138407&e=png&b=fefefe)

```js
// packages/taro-cli/bin/taro

#! /usr/bin/env node

require("../dist/util").printPkgVersion();

const CLI = require("../dist/cli").default;

new CLI().run();
```

æˆ‘ä»¬è·Ÿç€æ–­ç‚¹è¿›å…¥ï¼Œå…¥å£æ–‡ä»¶ä¸­çš„ç¬¬ä¸€å¥`require("../dist/util").printPkgVersion();` `printPkgVersion` å‡½æ•°ã€‚

## 4. taro-cli/src/utils/index.ts

å·¥å…·å‡½æ•°

```js
// packages/taro-cli/src/util/index.ts
import * as path from "path";

export function getRootPath(): string {
	return path.resolve(__dirname, "../../");
}

export function getPkgVersion(): string {
	return require(path.join(getRootPath(), "package.json")).version;
}

export function printPkgVersion() {
	console.log(`ğŸ‘½ Taro v${getPkgVersion()}`);
	console.log();
}
```

å¯ä»¥çœ‹å‡ºè¿™å¥è¾“å‡ºçš„æ˜¯ `taro/packages/taro-cli/package.json` çš„ç‰ˆæœ¬å·ã€‚

```js
ğŸ‘½ Taro v4.0.0
```

æˆ‘ä»¬ç»§ç»­è·Ÿç€æ–­ç‚¹ï¼Œè¿›å…¥ç¬¬äºŒç¬¬ä¸‰å¥ï¼Œå¯ä»¥è¿›å…¥åˆ° `packages/taro-cli/src/cli.ts` è¿™ä¸ªæ–‡ä»¶ã€‚

## 5. CLI æ•´ä½“ç»“æ„

`taro-cli` å¯¹åº”çš„æ–‡ä»¶è·¯å¾„æ˜¯ï¼š

> packages/taro-cli/src/cli.ts

æˆ‘ä»¬å…ˆæ¥çœ‹ä¸‹è¿™ä¸ªæ–‡ä»¶çš„æ•´ä½“ç»“æ„ã€‚`class CLI` ä¸€ä¸ª appPath å±æ€§ï¼ˆä¸€èˆ¬æŒ‡ `taro` å·¥ä½œç›®å½•ï¼‰ï¼Œä¸¤ä¸ªå‡½æ•° `run` å’Œ `parseArgs`ã€‚

```js
// packages/taro-cli/src/cli.ts
export default class CLI {
	appPath: string;
	constructor(appPath) {
		this.appPath = appPath || process.cwd();
	}

	run() {
		return this.parseArgs();
	}

	async parseArgs() {
		const args = minimist(process.argv.slice(2), {
			alias: {
				// çœç•¥ä¸€äº›åˆ«åè®¾ç½® ...
			},
			boolean: ["version", "help", "disable-global-config"],
			default: {
				build: true,
			},
		});
		const _ = args._;
		// initã€build ç­‰
		const command = _[0];
		if (command) {
			// çœç•¥è‹¥å¹²ä»£ç 
		} else {
			if (args.h) {
				// è¾“å‡ºå¸®åŠ©ä¿¡æ¯
				// çœç•¥ä»£ç 
			} else if (args.v) {
				// è¾“å‡ºç‰ˆæœ¬å·
				console.log(getPkgVersion());
			}
		}
	}
}
```

ä½¿ç”¨äº†[minimist](https://github.com/minimistjs/minimist)ï¼Œå‚æ•°è§£æå·¥å…·ã€‚

åŒç±»å·¥å…·è¿˜æœ‰ï¼š
[commander](https://github.com/tj/commander.js)ï¼Œå‘½ä»¤è¡Œå·¥å…·ã€‚åŠŸèƒ½é½å…¨çš„æ¡†æ¶ï¼Œæä¾›ç±»ä¼¼ git çš„å­å‘½ä»¤ç³»ç»Ÿï¼Œè‡ªåŠ¨ç”Ÿæˆå¸®åŠ©ä¿¡æ¯ç­‰ã€‚æœ‰å¾ˆå¤šçŸ¥åçš„ `cli` éƒ½æ˜¯ç”¨çš„è¿™ä¸ª[commander](https://www.npmjs.com/browse/depended/commander)ã€‚æ¯”å¦‚ï¼š[`vue-cli`](https://github.com/vuejs/vue-cli/blob/dev/packages/%40vue/cli/bin/vue.js#L37)ã€[`webpack-cli`](https://github.com/webpack/webpack-cli/blob/master/packages/webpack-cli/src/webpack-cli.ts#L64) å’Œ [`create-react-app`](https://github.com/facebook/create-react-app/blob/main/packages/create-react-app/createReactApp.js#L59) ç”¨çš„æ˜¯è¿™ä¸ªã€‚

[cac](https://github.com/cacjs/cac)ï¼Œç±»ä¼¼ `Commander.js` ä½†æ›´è½»å·§ã€ç°ä»£ï¼Œæ”¯æŒæ’ä»¶ã€‚ä¹Ÿæœ‰å¾ˆå¤šä½¿ç”¨è¿™ä¸ª[cac npm](https://www.npmjs.com/package/cac?activeTab=dependents)ï¼Œæ¯”å¦‚[`vite`](https://www.npmjs.com/package/vite?activeTab=dependencies) ä½¿ç”¨çš„æ˜¯è¿™ä¸ªã€‚

[yargs](https://github.com/yargs/yargs)ï¼Œäº¤äº’å¼å‘½ä»¤è¡Œå·¥å…·ã€‚åŠŸèƒ½å¼ºå¤§çš„æ¡†æ¶ï¼Œä½†æ˜¾å¾—è¿‡äºè‡ƒè‚¿ã€‚

`cli.run` å‡½æ•°æœ€ç»ˆè°ƒç”¨çš„æ˜¯ `cli.parseArgs` å‡½æ•°ã€‚æˆ‘ä»¬æ¥ç€æ¥çœ‹ `parseArgs` å‡½æ•°ã€‚

## 6. cli parseArgs

### 6.1 presets é¢„è®¾æ’ä»¶é›†åˆ

![parseArgs-1.png](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/3421a9f42d9746aeaf31459396383e86~tplv-k3u1fbpfcp-jj-mark:0:0:0:0:q75.image#?w=3066&h=1988&s=618972&e=png&b=262626)

`presets` å¯¹åº”çš„ç›®å½•ç»“æ„å¦‚å›¾æ‰€ç¤ºï¼š

![presets.png](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/6ac775f2413a4b45b271302b4fc6e740~tplv-k3u1fbpfcp-jj-mark:0:0:0:0:q75.image#?w=998&h=1692&s=172949&e=png&b=252525)

### 6.2 Config

![parseArgs-2.png](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/fb6920f397db4fc78e73abc29afddab2~tplv-k3u1fbpfcp-jj-mark:0:0:0:0:q75.image#?w=3414&h=1688&s=474740&e=png&b=252525)

`64-78` è¡Œä»£ç ï¼Œä»£ç é‡ç›¸å¯¹è¾ƒå°‘ï¼Œå°±æˆªå›¾åŒæ—¶é¡ºä¾¿ç›´æ¥æ”¾ä»£ç äº†ã€‚

```js
// packages/taro-cli/src/cli.ts
// è¿™é‡Œè§£æ dotenv ä»¥ä¾¿äº config è§£ææ—¶èƒ½è·å– dotenv é…ç½®ä¿¡æ¯
const expandEnv = dotenvParse(appPath, args.envPrefix, mode);

const disableGlobalConfig = !!(
	args["disable-global-config"] ||
	DISABLE_GLOBAL_CONFIG_COMMANDS.includes(command)
);

const configEnv = {
	mode,
	command,
};
const config = new Config({
	appPath: this.appPath,
	disableGlobalConfig: disableGlobalConfig,
});
await config.init(configEnv);
```

`dotenvParse` å‡½æ•°ç®€å•æ¥è¯´å°±æ˜¯é€šè¿‡ [dotenv](https://github.com/motdotla/dotenv) å’Œ [dotenv-expand](https://github.com/motdotla/dotenv-expand) è§£æ `.env`ã€`.env.development`ã€`.env.production` ç­‰æ–‡ä»¶å’Œå˜é‡çš„ã€‚

> `dotenv` æ˜¯ä¸€ä¸ªé›¶ä¾èµ–æ¨¡å—ï¼Œå¯å°† `.env` æ–‡ä»¶ä¸­çš„ç¯å¢ƒå˜é‡åŠ è½½åˆ° `process.env` ä¸­ã€‚

æˆ‘ä¹‹å‰å†™è¿‡ä¸€ç¯‡ [é¢è¯•å®˜ï¼šé¡¹ç›®ä¸­å¸¸ç”¨çš„ .env æ–‡ä»¶åŸç†æ˜¯ä»€ä¹ˆï¼Ÿå¦‚ä½•å®ç°ï¼Ÿ](https://juejin.cn/post/7045057475845816357)

æ¥ç€æˆ‘ä»¬æ¥çœ‹ `Config` ç±»ã€‚

```ts
// packages/taro-service/src/Config.ts
export default class Config {
	appPath: string;
	configPath: string;
	initialConfig: IProjectConfig;
	initialGlobalConfig: IProjectConfig;
	isInitSuccess: boolean;
	disableGlobalConfig: boolean;

	constructor(opts: IConfigOptions) {
		this.appPath = opts.appPath;
		this.disableGlobalConfig = !!opts?.disableGlobalConfig;
	}
	async init(configEnv: { mode: string; command: string }) {
		// ä»£ç çœç•¥
	}
	initGlobalConfig() {
		// ä»£ç çœç•¥
	}
	getConfigWithNamed(platform, configName) {
		// ä»£ç çœç•¥
	}
}
```

`Config` æ„é€ å‡½æ•°æœ‰ä¸¤ä¸ªå±æ€§ã€‚
`appPath` æ˜¯ `taro` é¡¹ç›®è·¯å¾„ã€‚
`disableGlobalConfig` æ˜¯ç¦ç”¨å…¨å±€é…ç½®ã€‚

æ¥ç€æˆ‘ä»¬æ¥çœ‹ `Config` ç±»çš„å®ä¾‹ä¸Šçš„ `init` æ–¹æ³•ã€‚

#### 6.2.1 config.init åˆå§‹åŒ–é…ç½®

è¯»å–çš„æ˜¯ `config/index` `.ts` æˆ–è€… `.js` åç¼€ã€‚
åˆ¤æ–­æ˜¯å¦ç¦ç”¨ `disableGlobalConfig` å…¨å±€é…ç½®ã€‚ä¸ç¦ç”¨åˆ™è¯»å–å…¨å±€é…ç½® `~/.taro-global-config/index.json`ã€‚

```ts
async init (configEnv: {
    mode: string
    command: string
  }) {
    this.initialConfig = {}
    this.initialGlobalConfig = {}
    this.isInitSuccess = false
    this.configPath = resolveScriptPath(path.join(this.appPath, CONFIG_DIR_NAME, DEFAULT_CONFIG_FILE))
    if (!fs.existsSync(this.configPath)) {
      if (this.disableGlobalConfig) return
      this.initGlobalConfig()
    } else {
      createSwcRegister({
        only: [
          filePath => filePath.indexOf(path.join(this.appPath, CONFIG_DIR_NAME)) >= 0
        ]
      })
      try {
        const userExport = getModuleDefaultExport(require(this.configPath))
        this.initialConfig = typeof userExport === 'function' ? await userExport(merge, configEnv) : userExport
        this.isInitSuccess = true
      } catch (err) {
        console.log(err)
      }
    }
  }
```

å€¼å¾—ä¸€æçš„æ˜¯ï¼š

![createSwcRegister.png](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/34924b795e2b4c8981ca0076eecfa8c4~tplv-k3u1fbpfcp-jj-mark:0:0:0:0:q75.image#?w=2774&h=1958&s=381062&e=png&b=252525)

`createSwcRegister` ä½¿ç”¨äº† [`@swc/register`](https://www.npmjs.com/package/@swc/register) æ¥ç¼–è¯‘ `ts` ç­‰è½¬æ¢æˆ `commonjs`ã€‚å¯ä»¥ç›´æ¥ç”¨ `require`ã€‚

> ä½¿ç”¨ swc çš„æ–¹æ³•ä¹‹ä¸€æ˜¯é€šè¿‡ `require` é’©å­ã€‚`require` é’©å­ä¼šå°†è‡ªèº«ç»‘å®šåˆ° `node` çš„ `require` å¹¶è‡ªåŠ¨åŠ¨æ€ç¼–è¯‘æ–‡ä»¶ã€‚ä¸è¿‡ç°åœ¨æ›´æ¨è [@swc-node/register](https://www.npmjs.com/package/@swc-node/register)ã€‚

```ts
export const getModuleDefaultExport = (exports) =>
	exports.__esModule ? exports.default : exports;
```

`this.initialConfig = typeof userExport === 'function' ? await userExport(merge, configEnv) : userExport`ã€‚è¿™å¥å°±æ˜¯ `config/index.ts` æ”¯æŒå‡½æ•°ä¹Ÿæ”¯æŒå¯¹è±¡çš„å®ç°ã€‚

æ¥ç€æˆ‘ä»¬æ¥çœ‹ `Config` ç±»çš„å®ä¾‹ä¸Šçš„ `initGlobalConfig` æ–¹æ³•ã€‚

#### 6.2.2 config.initGlobalConfig åˆå§‹åŒ–å…¨å±€é…ç½®

è¯»å–é…ç½® `~/.taro-global-config/index.json`ã€‚

```json
{
	"plugins": [],
	"presets": []
}
```

```ts
initGlobalConfig () {
    const homedir = getUserHomeDir()
    if (!homedir) return console.error('è·å–ä¸åˆ°ç”¨æˆ· home è·¯å¾„')
    const globalPluginConfigPath = path.join(getUserHomeDir(), TARO_GLOBAL_CONFIG_DIR, TARO_GLOBAL_CONFIG_FILE)
    if (!fs.existsSync(globalPluginConfigPath)) return
    const spinner = ora(`å¼€å§‹è·å– taro å…¨å±€é…ç½®æ–‡ä»¶ï¼š ${globalPluginConfigPath}`).start()
    try {
      this.initialGlobalConfig = fs.readJSONSync(globalPluginConfigPath) || {}
      spinner.succeed('è·å– taro å…¨å±€é…ç½®æˆåŠŸ')
    } catch (e) {
      spinner.stop()
      console.warn(`è·å–å…¨å±€é…ç½®å¤±è´¥ï¼Œå¦‚æœéœ€è¦å¯ç”¨å…¨å±€æ’ä»¶è¯·æŸ¥çœ‹é…ç½®æ–‡ä»¶: ${globalPluginConfigPath} `)
    }
  }
```

`getUserHomeDir` å‡½æ•°ä¸»è¦æ˜¯è·å–ç”¨æˆ·çš„ä¸»é¡µè·¯å¾„ã€‚æ¯”å¦‚ `mac` ä¸­æ˜¯ `/Users/ç”¨æˆ·å/`ã€‚
å¦‚æœæ”¯æŒ `os.homedir()` ç›´æ¥è·å–è¿”å›ï¼Œå¦‚æœä¸æ”¯æŒåˆ™æ ¹æ®å„ç§æ“ä½œç³»ç»Ÿå’Œç¯å¢ƒå˜é‡åˆ¤æ–­è·å–ã€‚

[ora](https://www.npmjs.com/package/ora) æ˜¯æ§åˆ¶å°çš„ loading å°åŠ¨ç”»ã€‚

> ä¼˜é›…çš„ç»ˆç«¯æ—‹è½¬å™¨

è¿™é‡Œçš„æ˜¯ `fs` æ˜¯ `@tarojs/helper` ã€‚

> Taro ç¼–è¯‘æ—¶å·¥å…·åº“ï¼Œä¸»è¦ä¾› CLIã€ç¼–è¯‘å™¨æ’ä»¶ä½¿ç”¨ã€‚

å¯¼å‡ºçš„ [fs-extra](https://www.npmjs.com/package/fs-extra)ã€‚

> fs-extra æ·»åŠ æœ¬æœºæ¨¡å—ä¸­æœªåŒ…å«çš„æ–‡ä»¶ç³»ç»Ÿæ–¹æ³• fsï¼Œå¹¶ä¸ºè¿™äº›æ–¹æ³•æ·»åŠ æ‰¿è¯ºæ”¯æŒ fsã€‚å®ƒè¿˜ç”¨äº graceful-fs é˜²æ­¢ EMFILE é”™è¯¯ã€‚å®ƒåº”è¯¥æ˜¯ çš„æ›¿ä»£å“ fsã€‚

ä½¿ç”¨ [fs.readJSONSync](https://github.com/jprichardson/node-fs-extra/blob/master/docs/readJson-sync.md) åŒæ­¥è¯»å– `json` çš„æ–¹æ³•ã€‚

æ–‡æ¡£ä¸­ä¹Ÿæœ‰å¯¹è¿™ä¸ªå…¨å±€å‚æ•°çš„æè¿°ã€‚

[å…¨å±€æ’ä»¶æˆ–æ’ä»¶é›†é…ç½®](https://docs.taro.zone/docs/next/cli/#%E5%85%A8%E5%B1%80%E6%8F%92%E4%BB%B6%E6%88%96%E6%8F%92%E4%BB%B6%E9%9B%86%E9%85%8D%E7%BD%AE)

![global-config.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/808b984f1f754942b7035515b0234906~tplv-k3u1fbpfcp-jj-mark:0:0:0:0:q75.image#?w=2304&h=1000&s=288783&e=png&b=f5f7f9)

`Config` éƒ¨åˆ†æˆ‘ä»¬åŸºæœ¬åˆ†æå®Œæˆï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å­¦ä¹  `Kernel` ï¼ˆå†…æ ¸ï¼‰éƒ¨åˆ†ã€‚

## 7. Kernel ï¼ˆå†…æ ¸ï¼‰

```ts
// packages/taro-cli/src/cli.ts

// çœç•¥è‹¥å¹²ä»£ç 
const kernel = new Kernel({
	appPath,
	presets: [path.resolve(__dirname, ".", "presets", "index.js")],
	config,
	plugins: [],
});
kernel.optsPlugins ||= [];
```

æ¥ç€æˆ‘ä»¬æ¥çœ‹ `Kernel` ç±»ï¼Œ `Kernel` ç±»ç»§æ‰¿è‡ª `Nodejs` çš„äº‹ä»¶æ¨¡å—`EventEmitter`ã€‚

```ts
// packages/taro-service/src/Kernel.ts
export default class Kernel extends EventEmitter {
	constructor(options: IKernelOptions) {
		super();
		this.debugger =
			process.env.DEBUG === "Taro:Kernel"
				? helper.createDebug("Taro:Kernel")
				: function () {};
		// taro é¡¹ç›®è·¯å¾„
		this.appPath = options.appPath || process.cwd();
		// é¢„è®¾æ’ä»¶é›†åˆ
		this.optsPresets = options.presets;
		// æ’ä»¶
		this.optsPlugins = options.plugins;
		// é…ç½®
		this.config = options.config;
		// é’©å­ï¼ŒMap å­˜å‚¨
		this.hooks = new Map();
		// å­˜å‚¨æ–¹æ³•
		this.methods = new Map();
		// å­˜å‚¨å‘½ä»¤
		this.commands = new Map();
		// å­˜å‚¨å¹³å°
		this.platforms = new Map();
		this.initHelper();
		this.initConfig();
		this.initPaths();
		this.initRunnerUtils();
	}
}
```

```ts
// packages/taro-helper/src/index.ts
export const createDebug = (id: string) => require("debug")(id);
```

`this.debugger` å½“æ²¡æœ‰é…ç½® `DEBUG` ç¯å¢ƒå˜é‡æ—¶ï¼Œåˆ™ `debugger` æ˜¯ç©ºå‡½æ•°ã€‚é…ç½®äº† `process.env.DEBUG === "Taro:Kernel"` ä¸ºåˆ™è°ƒç”¨çš„ `npm` åŒ… [debug](https://www.npmjs.com/package/debug)ã€‚

> ä¸€ä¸ªä»¿ç…§ `Node.js` æ ¸å¿ƒè°ƒè¯•æŠ€æœ¯çš„å¾®å‹ `JavaScript` è°ƒè¯•å®ç”¨ç¨‹åºã€‚é€‚ç”¨äº `Node.js` å’Œ `Web` æµè§ˆå™¨ã€‚

æˆ‘ä»¬æ¥ç€çœ‹æ„é€ å™¨å‡½æ•°é‡Œè°ƒç”¨çš„å‡ ä¸ªåˆå§‹åŒ–å‡½æ•°ï¼ŒåŸºæœ¬éƒ½æ˜¯é¡¾åçŸ¥ä¹‰ã€‚

```ts
// packages/taro-service/src/Kernel.ts
initConfig () {
	this.initialConfig = this.config.initialConfig
	this.initialGlobalConfig = this.config.initialGlobalConfig
	this.debugger('initConfig', this.initialConfig)
}

initHelper () {
	this.helper = helper
	this.debugger('initHelper')
}

initRunnerUtils () {
	this.runnerUtils = runnerUtils
	this.debugger('initRunnerUtils')
}
```

```ts
// packages/taro-service/src/Kernel.ts
initPaths () {
	this.paths = {
		appPath: this.appPath,
		nodeModulesPath: helper.recursiveFindNodeModules(path.join(this.appPath, helper.NODE_MODULES))
	} as IPaths
	if (this.config.isInitSuccess) {
		Object.assign(this.paths, {
		configPath: this.config.configPath,
		sourcePath: path.join(this.appPath, this.initialConfig.sourceRoot as string),
		outputPath: path.resolve(this.appPath, this.initialConfig.outputRoot as string)
		})
	}
	this.debugger(`initPaths:${JSON.stringify(this.paths, null, 2)}`)
}
```

åˆå§‹åŒ–åçš„å‚æ•°ï¼Œå¦‚ [`taro` å®˜æ–¹æ–‡æ¡£ - ç¼–å†™æ’ä»¶ api](https://docs.taro.zone/docs/next/plugin-custom#api)ä¸­æ‰€ç¤ºã€‚

![initConfig.png](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/820cb9df210647b7bd495a7c2d3e6a0c~tplv-k3u1fbpfcp-jj-mark:0:0:0:0:q75.image#?w=2148&h=1640&s=301305&e=png&b=fefefe)

### 7.1 cli kernel.optsPlugins ç­‰

![parseArgs-3.png](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/f5f628dcd6704742b6fedc23efe06e1f~tplv-k3u1fbpfcp-jj-mark:0:0:0:0:q75.image#?w=2598&h=1898&s=502975&e=png&b=262626)

æˆ‘ä»¬æ¥ä¸‹æ¥çœ‹ï¼Œ`customCommand` å‡½æ•°ã€‚

### 7.2 cli customCommand å‡½æ•°

![parseArgs-4.png](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/38cecda1701c467b926bb95235aeb8b6~tplv-k3u1fbpfcp-jj-mark:0:0:0:0:q75.image#?w=2008&h=1770&s=288624&e=png&b=252525)

æˆ‘ä»¬å¯ä»¥çœ‹åˆ°æœ€ç»ˆè°ƒç”¨çš„æ˜¯ `customCommand` å‡½æ•°

```ts
// packages/taro-cli/src/commands/customCommand.ts
import { Kernel } from "@tarojs/service";

export default function customCommand(
	command: string,
	kernel: Kernel,
	args: { _: string[]; [key: string]: any }
) {
	if (typeof command === "string") {
		const options: any = {};
		const excludeKeys = [
			"_",
			"version",
			"v",
			"help",
			"h",
			"disable-global-config",
		];
		Object.keys(args).forEach((key) => {
			if (!excludeKeys.includes(key)) {
				options[key] = args[key];
			}
		});

		kernel.run({
			name: command,
			opts: {
				_: args._,
				options,
				isHelp: args.h,
			},
		});
	}
}
```

`customCommand` å‡½æ•°ç§»é™¤ä¸€äº› `run` å‡½æ•°ä¸éœ€è¦çš„å‚æ•°ï¼Œæœ€ç»ˆè°ƒç”¨çš„æ˜¯ `kernal.run` å‡½æ•°ã€‚

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬æ¥çœ‹ `kernal.run` å‡½æ•°çš„å…·ä½“å®ç°ã€‚

## 8. kernal.run æ‰§è¡Œå‡½æ•°

```ts
// packages/taro-service/src/Kernel.ts
async run (args: string | { name: string, opts?: any }) {
	// ä¸ŠåŠéƒ¨åˆ†
    let name
    let opts
    if (typeof args === 'string') {
      name = args
    } else {
      name = args.name
      opts = args.opts
    }
    this.debugger('command:run')
    this.debugger(`command:run:name:${name}`)
    this.debugger('command:runOpts')
    this.debugger(`command:runOpts:${JSON.stringify(opts, null, 2)}`)
    this.setRunOpts(opts)
	// æ‹†è§£ä¸‹åŠéƒ¨åˆ†
}
```

`run` å‡½æ•°ä¸­ï¼Œå¼€å¤´ä¸»è¦æ˜¯å…¼å®¹ä¸¤ç§å‚æ•°ä¼ é€’ã€‚

## 9. kernal.setRunOpts

æŠŠå‚æ•°å…ˆå­˜èµ·æ¥ã€‚ä¾¿äºç»™æ’ä»¶ä½¿ç”¨ã€‚

```ts
// packages/taro-service/src/Kernel.ts
setRunOpts (opts) {
	this.runOpts = opts
}
```

[Taro æ–‡æ¡£ - ç¼–å†™æ’ä»¶ - ctx.runOpts](https://taro-docs.jd.com/docs/plugin-custom#ctxrunopts)

![ctx.runOpts.png](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/10422bfaec0540039a1d86d4748f1d6b~tplv-k3u1fbpfcp-jj-mark:0:0:0:0:q75.image#?w=2056&h=786&s=116172&e=png&b=ffffff)

æˆ‘ä»¬æ¥ç€æ¥çœ‹ï¼Œ`run` å‡½æ•°çš„ä¸‹åŠéƒ¨åˆ†ã€‚

```ts
// packages/taro-service/src/Kernel.ts
async run (args: string | { name: string, opts?: any }) {
    // ä¸‹åŠéƒ¨åˆ†
    this.debugger('initPresetsAndPlugins')
    this.initPresetsAndPlugins()

    await this.applyPlugins('onReady')

    this.debugger('command:onStart')
    await this.applyPlugins('onStart')

    if (!this.commands.has(name)) {
      throw new Error(`${name} å‘½ä»¤ä¸å­˜åœ¨`)
    }

    if (opts?.isHelp) {
      return this.runHelp(name)
    }

    if (opts?.options?.platform) {
      opts.config = this.runWithPlatform(opts.options.platform)
      await this.applyPlugins({
        name: 'modifyRunnerOpts',
        opts: {
          opts: opts?.config
        }
      })
    }

    await this.applyPlugins({
      name,
      opts
    })
}
```

`run` å‡½æ•°ä¸‹åŠéƒ¨åˆ†ä¸»è¦æœ‰ä¸‰ä¸ªå‡½æ•°ï¼š

```bash
1. this.initPresetsAndPlugins() å‡½æ•°ï¼Œé¡¾åçŸ¥ä¹‰ã€‚åˆå§‹åŒ–é¢„è®¾æ’ä»¶é›†åˆå’Œæ’ä»¶ã€‚
2. this.applyPlugins() æ‰§è¡Œæ’ä»¶
3. this.runHelp() æ‰§è¡Œ å‘½ä»¤è¡Œçš„å¸®åŠ©ä¿¡æ¯ï¼Œä¾‹ï¼štaro init --help
```

æˆ‘ä»¬åˆ†å¼€å™è¿°

> `this.initPresetsAndPlugins()`å‡½æ•°ï¼Œå› ä¸ºæ­¤å¤„æ¶‰åŠåˆ°çš„ä»£ç ç›¸å¯¹è¾ƒå¤šï¼Œå®¹æ˜“å½±å“ä¸»çº¿æµç¨‹ã€‚æ‰€ä»¥æœ¬æ–‡åœ¨æ­¤å…ˆä¸å±•å¼€æ·±å…¥å­¦ä¹ äº†ã€‚å°†æ”¾åœ¨ä¸‹ä¸€ç¯‡æ–‡ç« ä¸­è¯¦ç»†è®²è¿°ã€‚

æ‰§è¡Œ `this.initPresetsAndPlugins()` å‡½æ•°ä¹‹åã€‚æˆ‘ä»¬å®Œå…¨å¯ä»¥åœ¨è°ƒè¯•æ—¶æŠŠ `kernal` å®ä¾‹å¯¹è±¡æ‰“å°å‡ºæ¥ã€‚

æˆ‘ä»¬æ¥çœ‹æ’ä»¶çš„æ³¨å†Œã€‚

## 10. kernal ctx.registerCommand æ³¨å†Œ init å‘½ä»¤

```ts
// packages/taro-cli/src/presets/commands/init.ts
import type { IPluginContext } from "@tarojs/service";

export default (ctx: IPluginContext) => {
	ctx.registerCommand({
		name: "init",
		optionsMap: {
			"--name [name]": "é¡¹ç›®åç§°",
			"--description [description]": "é¡¹ç›®ä»‹ç»",
			"--typescript": "ä½¿ç”¨TypeScript",
			"--npm [npm]": "åŒ…ç®¡ç†å·¥å…·",
			"--template-source [templateSource]": "é¡¹ç›®æ¨¡æ¿æº",
			"--clone [clone]": "æ‹‰å–è¿œç¨‹æ¨¡æ¿æ—¶ä½¿ç”¨git clone",
			"--template [template]": "é¡¹ç›®æ¨¡æ¿",
			"--css [css]": "CSSé¢„å¤„ç†å™¨(sass/less/stylus/none)",
			"-h, --help": "output usage information",
		},
		async fn(opts) {
			// init project
			const { appPath } = ctx.paths;
			const { options } = opts;
			const {
				// çœç•¥è‹¥å¹²å‚æ•°
			} = options;
			const Project = require("../../create/project").default;
			console.log(Project, "Project");
			const project = new Project({
				projectName,
				projectDir: appPath,
				// çœç•¥è‹¥å¹²å‚æ•°
			});

			project.create();
		},
	});
};
```

é€šè¿‡ `ctx.registerCommand` æ³¨å†Œäº†ä¸€ä¸ª `name` ä¸º `init` çš„å‘½ä»¤ï¼Œä¼šå­˜å…¥åˆ°å†…æ ¸ `Kernal` å®ä¾‹å¯¹è±¡çš„ `hooks` å±æ€§ä¸­ï¼Œå…¶ä¸­ `ctx` å°±æ˜¯ `Kernal` çš„å®ä¾‹å¯¹è±¡ã€‚å…·ä½“å®ç°æ˜¯ `fn` å‡½æ•°ã€‚

## 11. kernal.applyPlugins è§¦å‘æ’ä»¶

```ts
// packages/taro-service/src/Kernel.ts
async applyPlugins (args: string | { name: string, initialVal?: any, opts?: any }) {
	// ä¸ŠåŠéƒ¨åˆ†
    let name
    let initialVal
    let opts
    if (typeof args === 'string') {
      name = args
    } else {
      name = args.name
      initialVal = args.initialVal
      opts = args.opts
    }
    this.debugger('applyPlugins')
    this.debugger(`applyPlugins:name:${name}`)
    this.debugger(`applyPlugins:initialVal:${initialVal}`)
    this.debugger(`applyPlugins:opts:${opts}`)
    if (typeof name !== 'string') {
      throw new Error('è°ƒç”¨å¤±è´¥ï¼Œæœªä¼ å…¥æ­£ç¡®çš„åç§°ï¼')
    }
	// æ‹†è§£åˆ°ä¸‹åŠéƒ¨åˆ†
}
```

ä¸ŠåŠéƒ¨åˆ†ï¼Œä¸»è¦æ˜¯é€‚é…ä¸¤ç§ä¼ å‚çš„æ–¹å¼ã€‚

```ts
// packages/taro-service/src/Kernel.ts
async applyPlugins (args: string | { name: string, initialVal?: any, opts?: any }) {
	// ä¸‹åŠéƒ¨åˆ†
	const hooks = this.hooks.get(name) || []
    if (!hooks.length) {
      return await initialVal
    }
    const waterfall = new AsyncSeriesWaterfallHook(['arg'])
    if (hooks.length) {
      const resArr: any[] = []
      for (const hook of hooks) {
        waterfall.tapPromise({
          name: hook.plugin!,
          stage: hook.stage || 0,
          // @ts-ignore
          before: hook.before
        }, async arg => {
          const res = await hook.fn(opts, arg)
          if (IS_MODIFY_HOOK.test(name) && IS_EVENT_HOOK.test(name)) {
            return res
          }
          if (IS_ADD_HOOK.test(name)) {
            resArr.push(res)
            return resArr
          }
          return null
        })
      }
    }
    return await waterfall.promise(initialVal)
}
```

`Taro` çš„æ’ä»¶æ¶æ„åŸºäº [Tapable](https://github.com/webpack/tapable)ã€‚

è¿™é‡Œä½¿ç”¨äº†è¿™ä¸ªå‡½æ•°ï¼š`AsyncSeriesWaterfallHook`ã€‚

> The hook type is reflected in its class name. E.g., AsyncSeriesWaterfallHook allows asynchronous functions and runs them in series, passing each functionâ€™s return value into the next function.

ç®€è¨€ä¹‹å°±æ˜¯å¼‚æ­¥æˆ–è€…åŒæ­¥æ–¹æ³•ä¸²è”èµ·æ¥ï¼Œä¸Šä¸€ä¸ªå‡½æ•°çš„ç»“æœä½œä¸ºä¸‹ä¸€ä¸ªå‡½æ•°çš„å‚æ•°ä¾æ¬¡æ‰§è¡Œã€‚ä¾æ¬¡æ‰§è¡Œã€‚

è¿™æ—¶è®©æˆ‘æƒ³èµ·ä¸€å¥å°è™é˜Ÿçš„çˆ±çš„æ­Œè¯ã€‚

> å–”ï¼ŒæŠŠä½ çš„å¿ƒæˆ‘çš„å¿ƒä¸²ä¸€ä¸²ï¼Œä¸²ä¸€æ ªå¹¸è¿è‰ä¸²ä¸€ä¸ªåŒå¿ƒåœ†...

ä¸¾ä¸ªä¾‹å­ç”¨æˆ·å†™çš„æ’ä»¶ä¸­æœ‰å¤šä¸ªé’©å­å‡½æ•°ã€‚æ¯”å¦‚ `onReday` ç­‰å¯ä»¥æœ‰å¤šä¸ªã€‚

![æ’ä»¶æ–¹æ³•.png](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/9568a4f0b4384b00bd3c3b3728c24487~tplv-k3u1fbpfcp-jj-mark:0:0:0:0:q75.image#?w=1458&h=1246&s=201717&e=png&b=ffffff)

![æ’ä»¶ hooks](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/02635270495948dabba4bd7863bd6019~tplv-k3u1fbpfcp-jj-mark:0:0:0:0:q75.image#?w=2090&h=922&s=352202&e=png&b=ffffff)

`applyPlugins` æ ¹æ®æ‰§è¡Œçš„å‘½ä»¤ `init` ä» `hooks` å–å‡ºï¼Œä¸²èµ·æ¥ï¼Œç„¶åä¾æ¬¡æ‰§è¡Œæ’ä»¶çš„ `fn` æ–¹æ³•ã€‚

æˆ‘ä»¬é¡ºä¾¿æ¥çœ‹ä¸€ä¸‹ï¼Œ`kernal.runHelp` çš„å®ç°ã€‚

## 12. kernal.runHelp å‘½ä»¤å¸®åŠ©ä¿¡æ¯

åœ¨ `kernal.run` å‡½æ•°ä¸­ï¼Œæœ‰ä¸€ä¸ª `opts.isHelp` çš„åˆ¤æ–­ï¼Œæ‰§è¡Œ `kernal.runHelp` æ–¹æ³•ã€‚

```ts
// packages/taro-service/src/Kernel.ts
// run å‡½æ•°
if (opts?.isHelp) {
	return this.runHelp(name);
}
```

ä»¥ `taro init --help` ä¸ºä¾‹ã€‚è¾“å‡ºç»“æœå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![å‘½ä»¤è¡Œ help.png](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/4c29f1a7d502421691461aeeae9e026e~tplv-k3u1fbpfcp-jj-mark:0:0:0:0:q75.image#?w=1704&h=758&s=253342&e=png&b=000000)

å…·ä½“å®ç°ä»£ç å¦‚ä¸‹ï¼š

```ts
// packages/taro-service/src/Kernel.ts
runHelp (name: string) {
    const command = this.commands.get(name)
    const defaultOptionsMap = new Map()
    defaultOptionsMap.set('-h, --help', 'output usage information')
    let customOptionsMap = new Map()
    if (command?.optionsMap) {
      customOptionsMap = new Map(Object.entries(command?.optionsMap))
    }
    const optionsMap = new Map([...customOptionsMap, ...defaultOptionsMap])
    printHelpLog(name, optionsMap, command?.synopsisList ? new Set(command?.synopsisList) : new Set())
}
```

æ ¹æ® `name` ä» `this.commands` `Map` ä¸­è·å–åˆ°å‘½ä»¤ï¼Œè¾“å‡ºå¯¹åº”çš„ `optionsMap` å’Œ `synopsisList`ã€‚

## 13. æ€»ç»“

æˆ‘ä»¬ä¸»è¦å­¦äº†

1.  å­¦ä¼šé€šè¿‡ä¸¤ç§æ–¹å¼è°ƒè¯• taro æºç 
2.  å­¦ä¼šå…¥å£ taro-cli å…·ä½“å®ç°æ–¹å¼
3.  å­¦ä¼š cli init å‘½ä»¤å®ç°åŸç†ï¼Œè¯»å–ç”¨æˆ·é¡¹ç›®é…ç½®æ–‡ä»¶å’Œç”¨æˆ·å…¨å±€é…ç½®æ–‡ä»¶
4.  å­¦ä¼š taro-service kernal ï¼ˆå†…æ ¸ï¼‰è§£è€¦å®ç°
5.  åˆæ­¥å­¦ä¼š taro æ’ä»¶æ¶æ„ï¼Œå­¦ä¼šäº†å¦‚ä½•ç¼–å†™ä¸€ä¸ª taro æ’ä»¶

taro-cli ä½¿ç”¨äº†[minimist](https://github.com/minimistjs/minimist)ï¼Œå‘½ä»¤è¡Œå‚æ•°è§£æå·¥å…·ã€‚

ä½¿ç”¨äº† [`@swc/register`](https://www.npmjs.com/package/@swc/register) è¯»å– config/index .js æˆ–è€… .ts é…ç½®æ–‡ä»¶å’Œç”¨ fs-extra [fs.readJSONSync](https://github.com/jprichardson/node-fs-extra/blob/master/docs/readJson-sync.md) å…¨å±€é…ç½®æ–‡ä»¶ã€‚

CLI éƒ¨åˆ†æœ‰å„ç§é¢„è®¾æ’ä»¶é›†åˆ `presets`ã€‚

taro å•ç‹¬æŠ½ç¦»äº†ä¸€ä¸ª `tarojs/service` (`packages/taro-service`) æ¨¡å—ï¼ŒåŒ…å« `Kernal` å†…æ ¸ã€`Config`ã€`Plugin` ç­‰ã€‚

taro çš„åŸºäº [Tapable](https://github.com/webpack/tapable) çš„ `AsyncSeriesWaterfallHook` (æŠŠå‡½æ•°ç»„åˆåœ¨ä¸€èµ·ä¸²è¡Œ) å®ç°çš„æ’ä»¶æœºåˆ¶ã€‚å„ä¸ªæ’ä»¶å¯ä»¥åˆ†å¼€åœ¨å„ä¸ªåœ°æ–¹ï¼Œè¾¾åˆ°è§£è€¦æ•ˆæœã€‚éå¸¸å€¼å¾—æˆ‘ä»¬å­¦ä¹ ã€‚

ç®€å•åšäº†ä¸€ä¸ªæœ¬æ–‡çš„æ€»ç»“å›¾ã€‚

![ç®€å•æ€»ç»“](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/541bfebea50f45fdb8e4e3acabfadc21~tplv-k3u1fbpfcp-jj-mark:0:0:0:0:q75.image#?w=3840&h=2160&s=904686&e=png&b=ffffff)

***

**å¦‚æœçœ‹å®Œæœ‰æ”¶è·ï¼Œæ¬¢è¿ç‚¹èµã€è¯„è®ºã€åˆ†äº«ã€æ”¶è—æ”¯æŒã€‚ä½ çš„æ”¯æŒå’Œè‚¯å®šï¼Œæ˜¯æˆ‘å†™ä½œçš„åŠ¨åŠ›**ã€‚

ä½œè€…ï¼šå¸¸ä»¥**è‹¥å·**ä¸ºåæ··è¿¹äºæ±Ÿæ¹–ã€‚æ‰€çŸ¥ç”šå°‘ï¼Œå”¯å–„å­¦ã€‚[è‹¥å·çš„åšå®¢](https://ruochuan12.github.io)

æœ€åå¯ä»¥æŒç»­å…³æ³¨æˆ‘[@è‹¥å·](https://juejin.cn/user/1415826704971918)ï¼Œæ¬¢è¿å…³æ³¨æˆ‘çš„[å…¬ä¼—å·ï¼šè‹¥å·è§†é‡](https://mp.weixin.qq.com/s/MacNfeTPODNMLLFdzrULow)ã€‚æˆ‘å€¾åŠ›æŒç»­ç»„ç»‡äº† 3 å¹´å¤š[æ¯å‘¨å¤§å®¶ä¸€èµ·å­¦ä¹  200 è¡Œå·¦å³çš„æºç å…±è¯»æ´»åŠ¨](https://juejin.cn/post/7079706017579139102)ï¼Œæ„Ÿå…´è¶£çš„å¯ä»¥[ç‚¹æ­¤æ‰«ç åŠ æˆ‘å¾®ä¿¡ `ruochuan02` å‚ä¸](https://juejin.cn/pin/7217386885793595453)ã€‚å¦å¤–ï¼Œæƒ³å­¦æºç ï¼ŒæåŠ›æ¨èå…³æ³¨æˆ‘å†™çš„ä¸“æ [ã€Šå­¦ä¹ æºç æ•´ä½“æ¶æ„ç³»åˆ—ã€‹](https://juejin.cn/column/6960551178908205093)ï¼Œç›®å‰æ˜¯æ˜é‡‘å…³æ³¨äººæ•°ï¼ˆ6k+äººï¼‰ç¬¬ä¸€çš„ä¸“æ ï¼Œå†™æœ‰å‡ åç¯‡æºç æ–‡ç« ã€‚
